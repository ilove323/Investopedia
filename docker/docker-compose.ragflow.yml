version: '3.8'

services:
  ragflow:
    image: infiniflow/ragflow:latest
    container_name: ragflow
    ports:
      - "${RAGFLOW_PORT:-9380}:9380"
    environment:
      # RAGFlow基础配置
      RAGFLOW_HOME: /home/ragflow
      SERVICE_HOST: "0.0.0.0"
      SERVICE_PORT: 9380

      # DeepSeek API配置
      LLM_MODEL: "deepseek-chat"
      LLM_API_BASE: "https://api.deepseek.com"
      LLM_API_KEY: "${DEEPSEEK_API_KEY}"

      # 其他配置
      MYSQL_USER: ragflow
      MYSQL_PASSWORD: ragflow123456
      MYSQL_DATABASE: ragflow

      # 日志级别
      LOG_LEVEL: INFO

    volumes:
      # 数据持久化
      - ragflow_data:/home/ragflow/data
      - ragflow_logs:/home/ragflow/logs

    networks:
      - policy_network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9380/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    restart: unless-stopped

  # MySQL数据库（RAGFlow依赖）
  mysql:
    image: mysql:8.0
    container_name: ragflow_mysql
    environment:
      MYSQL_ROOT_PASSWORD: ragflow123456
      MYSQL_DATABASE: ragflow
      MYSQL_USER: ragflow
      MYSQL_PASSWORD: ragflow123456
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - policy_network
    restart: unless-stopped

volumes:
  ragflow_data:
  ragflow_logs:
  mysql_data:

networks:
  policy_network:
    driver: bridge
